<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>磁贴</title>
</head>
<style>
/* 缓动 */
/* * {
    transition: all 1s;
    -webkit-transition: all 1s;
} */
body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        
        /* flexible box弹性布局，子元素的float，clear，vertical-align属性失效 */
        /* align-items:center; */
        /* align-items:定义flex容器内项目侧轴（纵轴）方向的对齐方式 */
        /* justify-content: center; */
        /* justify-content:设置弹性盒子元素在主轴（横轴）方向上的对齐方式 */
        min-height: 100vh;
        min-width: 100vw;
        /* vh:相对于视口的高度，视口被分为100单位的vh */
        background-color: #f3eeea;   
    }
.outbox{
    /* display: flex; */
    background: #ccc;
}
.Lbox{
    width: 18vmax;
    height: 8vmax;
    border: 1px solid rgb(255, 255, 255);
    background: rgb(48, 111, 245);
    margin: 1vmax;
    /* padding: 1vmax; */
}
.Mbox{
    width: 8vmax;
    height: 8vmax;
    border: 1px solid rgb(255, 255, 255);
    background: rgb(48, 111, 245);
    margin: 1vmax;
    /* padding: 1vmax; */
}
.Sbox{
    width: 3vmax;
    height: 3vmax;
    border: 1px solid rgb(255, 255, 255); 
    background: rgb(48, 111, 245);
    margin: 1vmax;
    /* padding: 1vmax; */
}
.box{
    cursor: move;
    color:#fff;
    text-align: center;
    padding: 0;
    background: rgba(0, 133, 185, 1);
    /* background: linear-gradient(
            290deg,
            rgba(0, 133, 185, 0.37) 0%,
            rgba(48, 111, 245, 1) 100%
        ); */
    /* box-sizing: border-box; */
    box-sizing: border-box;
    /* 暂时为空，1像素边距 */
    border: none;
    /* border: 4px solid red; */
    border: 2px solid transparent;
}
.box:hover{
    border: 2px solid rgb(255, 255, 255);
}
.box:before{
    content: "";
    display:inline-block;
    vertical-align:middle;
    height:100%;
}
</style>
<body>
    <div class="outbox">
        <div class="Lbox box">L</div> 
        <div id="Mbox" class="Mbox box">M</div>
        <div class="Mbox box">M</div>
        <div class="Sbox box">S</div>
        <div class="Sbox box">S</div>
        <div class="Sbox box">S</div>
        <div class="Sbox box">S</div>
        <div class="Lbox box">L</div> 
        <div id="Mbox" class="Mbox box">M</div>
        <div class="Mbox box">M</div>
        <div class="Sbox box">S</div>
        <div class="Sbox box">S</div>
        <div class="Sbox box">S</div>
        <div class="Sbox box">S</div>
        <div class="Lbox box">L</div> 
        <div id="Mbox" class="Mbox box">M</div>
        <div class="Mbox box">M</div>
        <div class="Sbox box">S</div>
        <div class="Sbox box">S</div>
        <div class="Sbox box">S</div>
        <div class="Sbox box">S</div>
    </div>
</body>
<script>
    //magin会出现小数的计算，需要统一 

var boxer = function(){
    return new boxer.prototype.init();
};
boxer.prototype = {
    init:function(){
        console.log("init boxer");

        this.len = 0;
        this.list = [];
        this.index = 0;
        this.word = "";
        this.width = 0;
        this.height = 0;
        this.oldtop = 0;
        this.oldleft = 0;
        this.leftIndex = 0;
        this.topIndex = 0;
        this.SBoxOffsetWidth = 0;
        this.defineSboxClassName = "Sbox";
        this.defineMboxClassName = "Mbox";
        this.defineLboxClassName = "Lbox";

        this.freedomBoxX = 0;
        this.freedomBoxY = 0;

        this.update = function(){

        };
        this.reload = function(){
            if(this.len!=0){
                console.log("reload");
                if(this.SBoxOffsetWidth!=0){
                    for(var i = 0;i<this.len;i++){
                        var el = this.list[i];
                        var className = el.className;
                        if(className.indexOf(this.defineSboxClassName)!=-1){
                            el.style.width = this.SBoxOffsetWidth+"px";
                            el.style.height = this.SBoxOffsetWidth+"px";
                            el.style.margin = this.SBoxOffsetWidth/3+"px";
                            //console.log(this.SBoxOffsetWidth);
                        }
                        if(className.indexOf(this.defineMboxClassName)!=-1){
                            el.style.width = (this.SBoxOffsetWidth/3)*8+"px";
                            el.style.height = (this.SBoxOffsetWidth/3)*8+"px";
                            el.style.margin = this.SBoxOffsetWidth/3+"px";
                        }
                        if(className.indexOf(this.defineLboxClassName)!=-1){
                            el.style.width = (this.SBoxOffsetWidth/3)*18+"px";
                            el.style.height = (this.SBoxOffsetWidth/3)*8+"px";
                            el.style.margin = this.SBoxOffsetWidth/3+"px";
                        }
                    }
                }
            }
            return this;
        };
        this.calLeftIndex = function(leftIndex){
            var width = this.width;
            
            var margin = this.SBoxOffsetWidth/3;
            var maxIndex = width/(this.SBoxOffsetWidth+margin*2);
            if(leftIndex>maxIndex){
                console.log(leftIndex)
                console.log(maxIndex)
                return false;
            }
            return true;
        },
        this.autoArrange = function(){
            //默认从左到右水平排
            console.log("autoArrange");
            var topIndex = 0;
            var leftIndex = 0;
            this.freedomBoxY = 0;
            this.freedomBoxX = 0;
            if(this.len!=0){
                if(this.SBoxOffsetWidth!=0){
                    for(var i = 0;i<this.len;i++){
                        var el = this.list[i];
                        var className = el.className;
                        if(className.indexOf(this.defineSboxClassName)!=-1){
                            

                            if(!this.calLeftIndex(leftIndex+1)){
                                topIndex = this.freedomBoxY;
                                console.log(this.freedomBoxY);
                                leftIndex = 0;
                            };

                            el.topIndex = topIndex;
                            el.leftIndex = leftIndex;
                            
                            el.style.position  = 'absolute';
                            
                            
                            var computedStyle = getComputedStyle(el);
                            var magrin = parseInt(computedStyle.margin.substring(0,computedStyle.margin.length-2));

                            //var margin = this.SBoxOffsetWidth/3;
                            el.style.top = topIndex*(this.SBoxOffsetWidth+margin*2)+"px";
                            el.style.left = leftIndex*(this.SBoxOffsetWidth+margin*2)+"px";
                            //console.log(this.SBoxOffsetWidth);
                            leftIndex++;
                            if(this.freedomBoxY<(topIndex+1)){
                                this.freedomBoxY = topIndex+1;
                            }
                            if(this.freedomBoxX<=leftIndex){
                                this.freedomBoxX = leftIndex+1;
                            }
                        }
                        if(className.indexOf(this.defineMboxClassName)!=-1){

                            if(!this.calLeftIndex(leftIndex+2)){
                                
                                console.log(this.freedomBoxY);
                                topIndex = this.freedomBoxY;
                                leftIndex = 0;
                            };

                            el.topIndex = topIndex;
                            el.leftIndex = leftIndex;
                            
                            el.style.position  = 'absolute';
                            
                            var computedStyle = getComputedStyle(el);
                            var margin = parseInt(computedStyle.margin.substring(0,computedStyle.margin.length-2));
                            
                            //var margin = this.SBoxOffsetWidth/3;

                            el.style.top = topIndex*(this.SBoxOffsetWidth+margin*2)+"px";
                            el.style.left = leftIndex*(this.SBoxOffsetWidth+margin*2)+"px";
                            //console.log(this.SBoxOffsetWidth);
                            leftIndex = leftIndex + 2;
                            if(this.freedomBoxY<(topIndex+2)){
                                this.freedomBoxY = topIndex+2;
                            }
                            if(this.freedomBoxX<=leftIndex){
                                this.freedomBoxX = leftIndex+2;
                            }
                        }
                        if(className.indexOf(this.defineLboxClassName)!=-1){

                            if(!this.calLeftIndex(leftIndex+4)){
                                
                                console.log(this.freedomBoxY);
                                topIndex = this.freedomBoxY;
                                leftIndex = 0;
                            };

                            el.topIndex = topIndex;
                            el.leftIndex = leftIndex;
                            
                            el.style.position  = 'absolute';
                            
                            var computedStyle = getComputedStyle(el);
                            var magrin = parseInt(computedStyle.margin.substring(0,computedStyle.margin.length-2));
                            
                            //margin = this.SBoxOffsetWidth/3;
                            console.log(margin*2);
                            
                            el.style.top = topIndex*(this.SBoxOffsetWidth+margin*2)+"px";
                            el.style.left = leftIndex*(this.SBoxOffsetWidth+margin*2)+"px";
                            //console.log(this.SBoxOffsetWidth);
                            leftIndex = leftIndex + 4;
                            if(this.freedomBoxY<(topIndex+2)){
                                this.freedomBoxY = topIndex+2;
                            }
                            if(this.freedomBoxX<=leftIndex){
                                this.freedomBoxX = leftIndex+4;
                            }
                        }
                    }
                }
                
            }

            return this;
        };
        this.scan = function(str){
            this.word = str;
            this.list =  document.querySelectorAll(str);
            this.len = this.list.length;
            return this;
        };
        this.addmoveaction = function(){
            for(var i = 0;i<this.len;i++){
                (function(i,that){
                    var el = that.list[i];
                    var computedStyle = getComputedStyle(el);
                    var magin = parseInt(computedStyle.margin.substring(0,computedStyle.margin.length-2));
                    el.topIndex = Math.floor(el.offsetTop/(el.offsetHeight+magin*2));
                    el.leftIndex = Math.floor(el.offsetLeft/(el.offsetWidth+magin*2));
                    //添加对象鼠标按下触发事件
                    el.onmousedown = function(e) {
                        var e = e || window.event;

                        that.consoleLogElInfo(el);

                        //获取按下鼠标到div left  top的距离
                        var disX = e.clientX - this.offsetLeft;
                        var disY = e.clientY - this.offsetTop;

                        //记录坐标
                        el.oldleft = this.offsetLeft;
                        el.oldtop = this.offsetTop;

                        //添加鼠标按下移动事件
                        document.onmousemove = function(e) {
                            var e = e || window.event;
                            el.style.position  = 'absolute';
                            el.style.left = (e.clientX - disX - magin) + 'px';
                            el.style.top = (e.clientY - disY - magin) + 'px';
                            el.style.transition = "";
                        };
                        //添加鼠标抬起事件
                        document.onmouseup = function(e) {
                            el.style.transition = "all 0.25s";
                            //检测碰撞或包含
                            if(that.checkcollide(el)){
                                //碰撞
                                //重新计算并恢复移动前的坐标
                                el.style.top = (el.topIndex*(that.SBoxOffsetWidth+magin*2)) + 'px';
                                el.style.left = (el.leftIndex*(that.SBoxOffsetWidth+magin*2)) + 'px';

                            }else{
                                //未碰撞
                                that.checkposition(el);
                            }

                            //清空事件
                            document.onmousemove = null;
                            document.onmouseup = null;
                        };
                        //阻止默认事件
                        return false;
                    };
                })(i,this)
            }
            return this;
        };
        this.checkposition = function(el){
            //获取对象的最终显示样式
            var computedStyle = getComputedStyle(el);
            //获取对象的margin长度
            var magin = parseInt(computedStyle.margin.substring(0,computedStyle.margin.length-2));

            var clientWidth = el.clientWidth;
            var clientHeight = el.clientHeight;
            var offsetWidth = el.offsetWidth;
            var offsetHeight = el.offsetHeight;
            var offsetTop = el.offsetTop;
            var offsetLeft = el.offsetLeft;
            var SBoxOffsetWidth = this.SBoxOffsetWidth;

            var maxTop = Math.floor((SBoxOffsetWidth+magin*2));
            var topIndex = Math.floor(offsetTop/(SBoxOffsetWidth+magin*2));
            //纵轴坐标计算
            var topTmp = offsetTop%(SBoxOffsetWidth+magin*2); 
            if(topTmp>(0.5*(SBoxOffsetWidth+magin*2))){
                topIndex++;
            }
            if(topIndex<0){
                topIndex = 0;
            }
            el.style.top = (topIndex*(SBoxOffsetWidth+magin*2)) + 'px';
            //横轴坐标计算
            var leftIndex = Math.floor(offsetLeft/(SBoxOffsetWidth+magin*2));
            var leftTmp = offsetLeft%(SBoxOffsetWidth+magin*2); 
            if(leftTmp>(0.5*(SBoxOffsetWidth+magin*2))){
                leftIndex++;
            }
            if(leftIndex<0){
                leftIndex = 0;
            }
            el.style.left = (leftIndex*(SBoxOffsetWidth+magin*2)) + 'px';

            //检测碰撞或包含
            if(this.checkcollide(el)){
                //再次碰撞
                //再次恢复
                var computedStyle = getComputedStyle(el);
                var magin = parseInt(computedStyle.margin.substring(0,computedStyle.margin.length-2));
                
                el.style.top = (el.topIndex*(el.offsetHeight+magin*2)) + 'px';
                el.style.left = (el.leftIndex*(el.offsetWidth+magin*2)) + 'px';

            }else{
                //最终确认对象坐标发生改变
                //对象元素自身记录新的坐标信息
                el.oldleft = el.style.left;
                el.oldtop = el.style.top;
                el.leftIndex = leftIndex;
                el.topIndex = topIndex; 
            }
        };
        //检测是否发生元素间的碰撞
        this.checkcollide = function(el){
            for(var i = 0;i<this.len;i++){
                var item = this.list[i];
                if(item!=el){
                    if(this.calculateCollide(el,item)){
                        console.log("collide");
                        return true;
                    }
                }
            }
            return false;
        };
        //计算两个元素是由存在重合的区域
        this.calculateCollide = function(el,item){
            if(!(el.offsetLeft>(item.offsetLeft+item.offsetWidth)
            || el.offsetTop>(item.offsetTop+item.offsetHeight)
            || (el.offsetTop+el.offsetHeight)<(item.offsetTop)
            || (el.offsetLeft+el.offsetWidth)<(item.offsetLeft)
            )){
                //碰撞
                return true;
            }
            return false;
        };
        //打印显示对象大小信息
        this.consoleLogElInfo = function(el){
            var computedStyle = getComputedStyle(el);
            var magin = parseInt(computedStyle.margin.substring(0,computedStyle.margin.length-2));
            var border = computedStyle.border;
            console.log("magin:"+magin);
            console.log("border:"+border);
        };
        this.aaa = function(){
            //console.log("cdkckdkcdkckdk");
        }
        //
        this.aaa();
        this.getMaxWidthHeight();
        
        return this;
    },
    //获取容器的大小
    getMaxWidthHeight:function(){
        var outboxs = document.getElementsByClassName("outbox");
        var Sbox = document.getElementsByClassName("Sbox");
        if(Sbox.length==0){
            var div = document.createElement("div");
            div.className = "Sbox box";
            outboxs[0].appendChild(div);
            this.SBoxOffsetWidth = div.offsetWidth;
            console.log(this.SBoxOffsetWidth);
            outboxs[0].removeChild(div);
        }
        if(outboxs.length>0){
            this.width = outboxs[0].offsetWidth;
            this.height = outboxs[0].offsetHeight;
            this.SBoxOffsetWidth = Sbox[0].offsetWidth;
            console.log(this.SBoxOffsetWidth);
        }
    }
}
boxer.prototype.init.prototype = boxer.prototype;
var boxer = boxer();
boxer.scan(".box").reload().addmoveaction().autoArrange();

window.onresize = function(){
    console.log("resize");
    boxer.getMaxWidthHeight();
    boxer.autoArrange();
}

</script>
</html>